<!-- AutoCheck BPEL Process [Generated by the Eclipse BPEL Designer] -->
<!-- Date: Wed May 27 01:05:27 EST 2015 -->
<bpel:process name="AutoCheck"
         targetNamespace="http://autocheck.soacourse.unsw.edu.au"
         suppressJoinFailure="yes"
         xmlns:tns="http://autocheck.soacourse.unsw.edu.au"
         xmlns:gs="http://greenslip.soacourse.unsw.edu.au"
         xmlns:ps="http://pinkslip.soacourse.unsw.edu.au"
         xmlns:bpel="http://docs.oasis-open.org/wsbpel/2.0/process/executable"
         xmlns:xsd="http://www.w3.org/2001/XMLSchema"
         >

    <!-- Import the client WSDL -->
  	<bpel:import location="AutoCheckArtifacts.wsdl"
	        namespace="http://autocheck.soacourse.unsw.edu.au" 
	        importType="http://schemas.xmlsoap.org/wsdl/" />
	  <bpel:import location="BPELGreenSlipService.wsdl"
          namespace="http://greenslip.soacourse.unsw.edu.au" 
	        importType="http://schemas.xmlsoap.org/wsdl/" />     
	  <bpel:import location="BPELPinkSlipService.wsdl"
          namespace="http://pinkslip.soacourse.unsw.edu.au" 
	        importType="http://schemas.xmlsoap.org/wsdl/" />          
    <!-- ================================================================= -->         
    <!-- PARTNERLINKS                                                      -->
    <!-- List of services participating in this BPEL process               -->
    <!-- ================================================================= -->         
    <bpel:partnerLinks>
        <!-- The 'client' role represents the requester of this service. -->
        <bpel:partnerLink name="client"
                     partnerLinkType="tns:AutoCheckLinkType"
                     myRole="AutoCheckProvider"
                     />
			  <bpel:partnerLink name="gsProvider"
                     partnerLinkType="tns:GSLinkType"
                     partnerRole="gsProvider"
                     /> 
        <bpel:partnerLink name="psProvider"
                     partnerLinkType="tns:PSLinkType"
                     partnerRole="psProvider"
                     />                     
    </bpel:partnerLinks>
  
    <!-- ================================================================= -->         
    <!-- VARIABLES                                                         -->
    <!-- List of messages and XML documents used within this BPEL process  -->
    <!-- ================================================================= -->         
    <bpel:variables>
        <!-- Reference to the message passed as input during initiation -->
        <bpel:variable name="input"
                  messageType="tns:AutoCheckRequestMessage"/>
        <bpel:variable name="output"
                  messageType="tns:AutoCheckResponseMessage"/>          
                  
                  
        <bpel:variable name="GSCheckInput"
                  messageType="gs:GSCheckRequestMsg"/>
        <bpel:variable name="GSCheckOutput"
                  messageType="gs:GSCheckResponseMsg"/>                
        <bpel:variable name="GSCheckFault"
                  messageType="gs:GSCheckFaultMsg"/>
        
        <bpel:variable name="PSCheckInput"
                  messageType="ps:PSCheckRequestMsg"/>
        <bpel:variable name="PSCheckOutput"
                  messageType="ps:PSCheckResponseMsg"/>                
        <bpel:variable name="PSCheckFault"
                  messageType="ps:PSCheckFaultMsg"/>
        
        
        <bpel:variable name="VehicleAgeInput"
                  messageType="ps:VehicleAgeRequestMsg"/>
        <bpel:variable name="VehicleAgeOutput"
                  messageType="ps:VehicleAgeResponseMsg"/>                
        <bpel:variable name="VehicleAgeFault"
                  messageType="ps:VehicleAgeFaultMsg"/>
    </bpel:variables>

    <!-- ================================================================= -->         
    <!-- ORCHESTRATION LOGIC                                               -->
    <!-- Set of activities coordinating the flow of messages across the    -->
    <!-- services integrated within this business process                  -->
    <!-- ================================================================= -->         
<bpel:sequence name="main">
        
        <!-- Receive input from requester. 
             Note: This maps to operation defined in AutoCheck.wsdl 
             -->
        <bpel:receive name="receiveInput"
        	       partnerLink="client"
                 portType="tns:AutoCheck"
                 operation="AutoCheck"
                 variable="input"
                 createInstance="yes"/>
        <bpel:assign validate="no" name="inputToGSCheckInput">
            <bpel:copy>
                <bpel:from><bpel:literal><tns:GSCheckRequest xmlns:tns="http://greenslip.soacourse.unsw.edu.au" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
  <LastName>LastName</LastName>
  <FirstName>FirstName</FirstName>
  <RegoNumber>RegoNumber</RegoNumber>
</tns:GSCheckRequest>
</bpel:literal></bpel:from>
                <bpel:to variable="GSCheckInput" part="parameters"></bpel:to>
            </bpel:copy>
            <bpel:copy>
                <bpel:from part="parameters" variable="input">
                    <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[tns:LastName]]></bpel:query>
                </bpel:from>
                <bpel:to part="parameters" variable="GSCheckInput">
                    <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[LastName]]></bpel:query>
                </bpel:to>
            </bpel:copy>
            <bpel:copy>
                <bpel:from part="parameters" variable="input">
                    <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[tns:FirstName]]></bpel:query>
                </bpel:from>
                <bpel:to part="parameters" variable="GSCheckInput">
                    <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[FirstName]]></bpel:query>
                </bpel:to>
            </bpel:copy>
            <bpel:copy>
                <bpel:from part="parameters" variable="input">
                    <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[tns:RegoNumber]]></bpel:query>
                </bpel:from>
                <bpel:to part="parameters" variable="GSCheckInput">
                    <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[RegoNumber]]></bpel:query>
                </bpel:to>
            </bpel:copy>
        </bpel:assign>
        
        
        <bpel:invoke name="GSCheck"
                 partnerLink="gsProvider"
                 portType="gs:BPELGreenSlipService"
                 operation="GSCheck"
                 inputVariable="GSCheckInput"
                 outputVariable="GSCheckOutput">
            <bpel:catch faultName="gs:checkFault" faultVariable="GSCheckFault" faultMessageType="gs:GSCheckFaultMsg"><bpel:sequence><bpel:documentation xml:lang="English (United States)"></bpel:documentation><bpel:assign validate="no" name="setError">

                        
                        
                        <bpel:copy>
                            <bpel:from><bpel:literal xml:space="preserve"><tns:AutoCheckResponse xmlns:tns="http://autocheck.soacourse.unsw.edu.au" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
  <tns:GSCheck>tns:GSCheck</tns:GSCheck>
  <tns:result>Error</tns:result>
</tns:AutoCheckResponse></bpel:literal></bpel:from>
                            <bpel:to variable="output" part="parameters"></bpel:to>
                        </bpel:copy>
                        <bpel:copy>
                            <bpel:from part="parameters" variable="GSCheckFault">
                                <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[errtext]]></bpel:query>
                            </bpel:from>
                            <bpel:to part="parameters" variable="output">
                                <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[tns:GSCheck]]></bpel:query>
                            </bpel:to>
                        </bpel:copy>
                    </bpel:assign><bpel:reply name="replyError" partnerLink="client" operation="AutoCheck" portType="tns:AutoCheck" variable="output"></bpel:reply><bpel:exit name="Exit"></bpel:exit></bpel:sequence></bpel:catch></bpel:invoke>
        
        <bpel:if name="HasPaid">
            <bpel:condition expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[$GSCheckOutput.parameters/PaidFlag = "Yes"]]></bpel:condition>
            <bpel:sequence name="Paid">
                <bpel:assign validate="no" name="InputToVehicleAgeInput">
                    
            
            
    
    
    
    
    
    

                
                    <bpel:copy>
                        <bpel:from><bpel:literal><tns:VehicleAgeRequest xmlns:tns="http://pinkslip.soacourse.unsw.edu.au" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
  <LastName>LastName</LastName>
  <FirstName>FirstName</FirstName>
  <RegoNumber>RegoNumber</RegoNumber>
</tns:VehicleAgeRequest>
</bpel:literal></bpel:from>
                        <bpel:to variable="VehicleAgeInput" part="parameters"></bpel:to>
                    </bpel:copy>
                    <bpel:copy>
                        <bpel:from part="parameters" variable="input">
                            <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[tns:LastName]]></bpel:query>
                        </bpel:from>
                        <bpel:to part="parameters" variable="VehicleAgeInput">
                            <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[LastName]]></bpel:query>
                        </bpel:to>
                    </bpel:copy>
                    <bpel:copy>
                        <bpel:from part="parameters" variable="input">
                            <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[tns:FirstName]]></bpel:query>
                        </bpel:from>
                        <bpel:to part="parameters" variable="VehicleAgeInput">
                            <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[FirstName]]></bpel:query>
                        </bpel:to>
                    </bpel:copy>
                    <bpel:copy>
                        <bpel:from part="parameters" variable="input">
                            <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[tns:RegoNumber]]></bpel:query>
                        </bpel:from>
                        <bpel:to part="parameters" variable="VehicleAgeInput">
                            <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[RegoNumber]]></bpel:query>
                        </bpel:to>
                    </bpel:copy>
                </bpel:assign>
                <bpel:invoke name="VehicleAge"
                 partnerLink="psProvider"
                 portType="ps:BPELPinkSlipService"
                 operation="VehicleAge"
                 inputVariable="VehicleAgeInput"
                 outputVariable="VehicleAgeOutput"><bpel:catch faultName="ps:ageFault" faultVariable="VehicleAgeFault" faultMessageType="ps:VehicleAgeFaultMsg"><bpel:sequence>
                            <bpel:assign validate="no" name="setError">
                                <bpel:copy>
                                    <bpel:from><bpel:literal xml:space="preserve"><tns:AutoCheckResponse xmlns:tns="http://autocheck.soacourse.unsw.edu.au" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
  <tns:GSCheck>Passed</tns:GSCheck>
  <tns:AgeCheck>tns:AgeCheck</tns:AgeCheck>
  <tns:result>Error</tns:result>
</tns:AutoCheckResponse>
</bpel:literal></bpel:from>
                                    <bpel:to variable="output" part="parameters"></bpel:to>
                                </bpel:copy>
                                <bpel:copy>
                                    <bpel:from part="parameters" variable="VehicleAgeFault">
                                        <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                                            <![CDATA[errtext]]>
                                        </bpel:query>
                                    </bpel:from>
                                    <bpel:to part="parameters" variable="output">
                                        <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                                            <![CDATA[tns:AgeCheck]]>
                                        </bpel:query>
                                    </bpel:to>
                                </bpel:copy>
                            </bpel:assign>
                            <bpel:reply name="replyError" partnerLink="client" operation="AutoCheck" portType="tns:AutoCheck" variable="output"></bpel:reply>
                            <bpel:exit name="Exit"></bpel:exit>
                        </bpel:sequence></bpel:catch></bpel:invoke>
                <bpel:if name="CheckAgeGreaterThan5">
                    <bpel:condition expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[$VehicleAgeOutput.parameters/Age > 5]]></bpel:condition>
                    <bpel:sequence name="AgeGreaterThan5">
                        <bpel:assign validate="no" name="InputToPSCheckInput">
                            <bpel:copy>
                                <bpel:from><bpel:literal><tns:PSCheckRequest xmlns:tns="http://pinkslip.soacourse.unsw.edu.au" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
  <LastName>LastName</LastName>
  <FirstName>FirstName</FirstName>
  <RegoNumber>RegoNumber</RegoNumber>
</tns:PSCheckRequest>
</bpel:literal></bpel:from>
                                <bpel:to variable="PSCheckInput" part="parameters"></bpel:to>
                            </bpel:copy>
                            <bpel:copy>
                                <bpel:from part="parameters" variable="input">
                                    <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[tns:LastName]]></bpel:query>
                                </bpel:from>
                                <bpel:to part="parameters" variable="PSCheckInput">
                                    <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[LastName]]></bpel:query>
                                </bpel:to>
                            </bpel:copy>
                            <bpel:copy>
                                <bpel:from part="parameters" variable="input">
                                    <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                                        <![CDATA[tns:FirstName]]>
                                    </bpel:query>
                                </bpel:from>
                                <bpel:to part="parameters" variable="PSCheckInput">
                                    <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[FirstName]]></bpel:query>
                                </bpel:to>
                            </bpel:copy>
                            <bpel:copy>
                                <bpel:from part="parameters" variable="input">
                                    <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[tns:RegoNumber]]></bpel:query>
                                </bpel:from>
                                <bpel:to part="parameters" variable="PSCheckInput">
                                    <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[RegoNumber]]></bpel:query>
                                </bpel:to>
                            </bpel:copy>
                        </bpel:assign>
                        
                        <bpel:invoke name="PSCheck"
                        partnerLink="psProvider"
                        operation="PSCheck"
                        inputVariable="PSCheckInput"
                        outputVariable="PSCheckOutput"
                        portType="ps:BPELPinkSlipService">
                        <bpel:catch faultName="ps:checkFault" faultVariable="PSCheckFault" faultMessageType="ps:PSCheckFaultMsg"><bpel:sequence>
                                    <bpel:assign validate="no" name="setError">
                                        
                                        <bpel:copy>
                                            <bpel:from><bpel:literal xml:space="preserve"><tns:AutoCheckResponse xmlns:tns="http://autocheck.soacourse.unsw.edu.au" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
  <tns:GSCheck>Passed</tns:GSCheck>
  <tns:AgeCheck>Greater than 5 years old</tns:AgeCheck>
  <tns:PSCheck>tns:PSCheck</tns:PSCheck>
  <tns:result>Error</tns:result>
</tns:AutoCheckResponse></bpel:literal></bpel:from>
                                            <bpel:to variable="output" part="parameters"></bpel:to>
                                        </bpel:copy>
                                        <bpel:copy>
                                            <bpel:from part="parameters" variable="PSCheckFault">
                                                <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[errtext]]></bpel:query>
                                            </bpel:from>
                                            <bpel:to part="parameters" variable="output">
                                                <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[tns:PSCheck]]></bpel:query>
                                            </bpel:to>
                                        </bpel:copy>
                                    </bpel:assign>
                                    <bpel:reply name="replyError" partnerLink="client" operation="AutoCheck" portType="tns:AutoCheck" variable="output"></bpel:reply>
                                    <bpel:exit name="Exit"></bpel:exit>
                                </bpel:sequence></bpel:catch></bpel:invoke>
                        <bpel:if name="HasCheckedSafety">
                            <bpel:condition expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[$PSCheckOutput.parameters/CheckedFlag = "Yes"]]></bpel:condition>
                            <bpel:assign validate="no" name="Accept"><bpel:copy><bpel:from><bpel:literal xml:space="preserve"><tns:AutoCheckResponse xmlns:tns="http://autocheck.soacourse.unsw.edu.au" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
  <tns:GSCheck>Passed</tns:GSCheck>
  <tns:AgeCheck>Greater than 5 years old</tns:AgeCheck>
  <tns:PSCheck>Passed</tns:PSCheck>  
  <tns:result>Accept</tns:result>
</tns:AutoCheckResponse></bpel:literal>
                                        
                                        </bpel:from>
                                        <bpel:to variable="output" part="parameters"></bpel:to>
                                
                                    
                                    
                                    
                            </bpel:copy>
                                
                                
                                
                                
                                
                                
                        
                            </bpel:assign>
                            <bpel:else>
                                <bpel:assign validate="no" name="Reject">
                                    <bpel:copy><bpel:from>
                                            <bpel:literal xml:space="preserve"><tns:AutoCheckResponse xmlns:tns="http://autocheck.soacourse.unsw.edu.au" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
  <tns:GSCheck>Passed</tns:GSCheck>
  <tns:AgeCheck>Greater than 5 years old</tns:AgeCheck>
  <tns:PSCheck>Failed</tns:PSCheck>
  <tns:result>Reject</tns:result>
</tns:AutoCheckResponse></bpel:literal>
                                        </bpel:from><bpel:to variable="output" part="parameters"></bpel:to>
                
                                
                                    
                                    </bpel:copy>
                            
                            
                                
                                
    
</bpel:assign>
                            </bpel:else>
                        </bpel:if>
                        
                        
                        
                    </bpel:sequence>
                    <bpel:else>
                        <bpel:assign validate="no" name="Accept">
                    
                
                            <bpel:copy>
                                <bpel:from><bpel:literal xml:space="preserve"><tns:AutoCheckResponse xmlns:tns="http://autocheck.soacourse.unsw.edu.au" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
  <tns:GSCheck>Passed</tns:GSCheck>
  <tns:AgeCheck>Less or equal to 5 years old</tns:AgeCheck>
  <tns:result>Accept</tns:result>
</tns:AutoCheckResponse></bpel:literal></bpel:from>
                                <bpel:to variable="output" part="parameters"></bpel:to>
                            </bpel:copy>
                            
                        </bpel:assign>
                    </bpel:else>
                </bpel:if>
                
                
                
            </bpel:sequence>
            <bpel:else>
                <bpel:assign validate="no" name="Reject"><bpel:copy><bpel:from><bpel:literal xml:space="preserve"><tns:AutoCheckResponse xmlns:tns="http://autocheck.soacourse.unsw.edu.au" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
  <tns:GSCheck>Failed</tns:GSCheck>
  <tns:result>Reject</tns:result>
</tns:AutoCheckResponse></bpel:literal></bpel:from>
                    <bpel:to variable="output" part="parameters"></bpel:to>
                
            </bpel:copy>
                    
        
                </bpel:assign>
            </bpel:else>
        </bpel:if>
        <bpel:reply name="replyOutput" 
               partnerLink="client"
               portType="tns:AutoCheck"
               operation="AutoCheck" 
               variable="output"
               />
        
    </bpel:sequence>

</bpel:process>

